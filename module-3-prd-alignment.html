<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Module 3: PRD Generation & 3-Tier Alignment | Project Conductor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 20px 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #2d3748;
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .phase-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .main-container {
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            gap: 20px;
            height: calc(100vh - 120px);
        }

        .panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 20px;
            font-weight: 600;
            font-size: 16px;
            border-bottom: 3px solid rgba(255,255,255,0.3);
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        /* Left Panel - Requirements Stream */
        .requirement-item {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .requirement-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .requirement-item.active {
            border-color: #667eea;
            background: #edf2f7;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .req-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 8px;
        }

        .req-id {
            font-weight: 700;
            color: #667eea;
            font-size: 13px;
        }

        .req-title {
            font-size: 14px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 6px;
        }

        .req-meta {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .priority-badge, .type-badge {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: 600;
        }

        .priority-critical {
            background: #fed7d7;
            color: #c53030;
        }

        .priority-high {
            background: #feebc8;
            color: #c05621;
        }

        .priority-medium {
            background: #fefcbf;
            color: #975a16;
        }

        .priority-low {
            background: #c6f6d5;
            color: #22543d;
        }

        .type-badge {
            background: #bee3f8;
            color: #2c5282;
        }

        .alignment-status {
            display: flex;
            gap: 4px;
            margin-top: 8px;
        }

        .status-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            border: 2px solid;
        }

        .status-aligned {
            background: #c6f6d5;
            border-color: #48bb78;
            color: #22543d;
        }

        .status-concern {
            background: #fefcbf;
            border-color: #ecc94b;
            color: #975a16;
        }

        .status-blocked {
            background: #fed7d7;
            border-color: #f56565;
            color: #c53030;
        }

        /* Center Panel - Requirement Detail */
        .detail-section {
            margin-bottom: 24px;
        }

        .detail-section h3 {
            color: #2d3748;
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .detail-input:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea.detail-input {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }

        .select-input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        .acceptance-criteria {
            list-style: none;
        }

        .criteria-item {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        .criteria-item input {
            flex: 1;
        }

        .btn-add-criteria {
            background: #e2e8f0;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: #4a5568;
            margin-top: 8px;
        }

        .btn-add-criteria:hover {
            background: #cbd5e0;
        }

        .dependencies-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .dependency-chip {
            background: #edf2f7;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            color: #4a5568;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .remove-chip {
            cursor: pointer;
            color: #e53e3e;
            font-weight: 700;
        }

        /* Right Panel - Stakeholder Alignment */
        .alignment-summary {
            background: #f7fafc;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
        }

        .progress-bar {
            background: #e2e8f0;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin: 8px 0;
        }

        .progress-fill {
            background: linear-gradient(90deg, #48bb78, #38a169);
            height: 100%;
            transition: width 0.3s;
        }

        .progress-text {
            font-size: 13px;
            color: #4a5568;
            text-align: center;
            margin-top: 4px;
        }

        .stakeholder-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .stakeholder-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white;
            font-size: 16px;
            position: relative;
        }

        .avatar-sarah { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .avatar-mike { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .avatar-emma { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .avatar-david { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }

        .status-badge {
            position: absolute;
            bottom: -2px;
            right: -2px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 2px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }

        .badge-aligned {
            background: #48bb78;
            color: white;
        }

        .badge-concern {
            background: #ecc94b;
            color: #975a16;
        }

        .badge-blocked {
            background: #f56565;
            color: white;
        }

        .stakeholder-info h4 {
            font-size: 14px;
            color: #2d3748;
            font-weight: 700;
        }

        .stakeholder-role {
            font-size: 12px;
            color: #718096;
        }

        .alignment-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .btn-alignment {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-aligned {
            background: #c6f6d5;
            color: #22543d;
        }

        .btn-aligned:hover {
            background: #9ae6b4;
        }

        .btn-concern {
            background: #fefcbf;
            color: #975a16;
        }

        .btn-concern:hover {
            background: #faf089;
        }

        .btn-blocked {
            background: #fed7d7;
            color: #c53030;
        }

        .btn-blocked:hover {
            background: #fcb3b3;
        }

        .concern-panel, .blocked-panel {
            margin-top: 12px;
            padding: 12px;
            border-radius: 6px;
            background: #f7fafc;
        }

        .concern-panel {
            border-left: 4px solid #ecc94b;
        }

        .blocked-panel {
            border-left: 4px solid #f56565;
        }

        .panel-label {
            font-size: 12px;
            font-weight: 700;
            color: #4a5568;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .concern-input, .blocked-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            font-size: 13px;
            margin-bottom: 8px;
        }

        .action-buttons {
            display: flex;
            gap: 6px;
            margin-top: 8px;
        }

        .btn-action {
            flex: 1;
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-accept {
            background: #48bb78;
            color: white;
        }

        .btn-discuss {
            background: #4299e1;
            color: white;
        }

        .btn-override {
            background: #ed8936;
            color: white;
        }

        .btn-schedule {
            background: #9f7aea;
            color: white;
        }

        .timestamp {
            font-size: 11px;
            color: #a0aec0;
            margin-top: 8px;
        }

        .comment-box {
            margin-top: 8px;
        }

        .comment-text {
            font-size: 12px;
            color: #4a5568;
            font-style: italic;
            padding: 8px;
            background: white;
            border-radius: 4px;
            border-left: 3px solid #48bb78;
        }

        /* Dashboard Summary */
        .dashboard-summary {
            background: #f7fafc;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-top: 12px;
        }

        .summary-card {
            text-align: center;
            padding: 12px;
            background: white;
            border-radius: 6px;
            border: 2px solid #e2e8f0;
        }

        .summary-card h4 {
            font-size: 11px;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .summary-stats {
            font-size: 12px;
            color: #4a5568;
        }

        .stat-number {
            font-size: 18px;
            font-weight: 700;
            display: block;
            margin: 4px 0;
        }

        .stat-aligned { color: #48bb78; }
        .stat-concern { color: #ecc94b; }
        .stat-blocked { color: #f56565; }

        /* Unblocking Panel */
        .unblock-panel {
            background: #fff5f5;
            border: 2px solid #feb2b2;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .unblock-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .unblock-header h4 {
            color: #c53030;
            font-size: 14px;
            font-weight: 700;
        }

        .unblock-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .unblock-action {
            color: #4299e1;
            cursor: pointer;
            font-weight: 600;
            margin-top: 4px;
            display: inline-block;
        }

        /* Discussion Thread */
        .discussion-thread {
            margin-top: 12px;
            max-height: 200px;
            overflow-y: auto;
        }

        .thread-message {
            background: white;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 6px;
            font-size: 12px;
        }

        .thread-author {
            font-weight: 700;
            color: #4a5568;
        }

        .thread-text {
            color: #718096;
            margin-top: 2px;
        }

        .thread-input {
            display: flex;
            gap: 6px;
            margin-top: 8px;
        }

        .thread-input input {
            flex: 1;
            padding: 6px 8px;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            font-size: 12px;
        }

        .btn-send {
            padding: 6px 12px;
            background: #4299e1;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        /* Filters */
        .filter-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .filter-btn {
            padding: 6px 12px;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        /* PRD Preview */
        .prd-preview {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-top: 16px;
        }

        .prd-section {
            margin-bottom: 20px;
        }

        .prd-section h3 {
            color: #2d3748;
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 12px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 8px;
        }

        .prd-content {
            font-size: 13px;
            color: #4a5568;
            line-height: 1.6;
        }

        .signoff-list {
            list-style: none;
        }

        .signoff-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            font-size: 13px;
        }

        .btn-export {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 16px;
        }

        .btn-export:hover {
            opacity: 0.9;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #2d3748;
            font-size: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #a0aec0;
            cursor: pointer;
        }

        .notification-badge {
            background: #f56565;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            position: absolute;
            top: -8px;
            right: -8px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #a0aec0;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        /* Animations */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .requirement-item {
            animation: slideIn 0.3s ease-out;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>
            <span>Module 3: PRD Generation & 3-Tier Alignment</span>
        </h1>
        <span class="phase-badge">Phase 3 Active</span>
    </div>

    <div class="main-container">
        <!-- Left Panel: Requirements Stream -->
        <div class="panel">
            <div class="panel-header">
                Requirements Stream
            </div>
            <div class="panel-content">
                <div class="filter-bar">
                    <button class="filter-btn active" onclick="filterRequirements('all')">All</button>
                    <button class="filter-btn" onclick="filterRequirements('aligned')">✅</button>
                    <button class="filter-btn" onclick="filterRequirements('concern')">⚠️</button>
                    <button class="filter-btn" onclick="filterRequirements('blocked')">❌</button>
                </div>
                <div id="requirementsList">
                    <!-- Requirements will be populated here -->
                </div>
            </div>
        </div>

        <!-- Center Panel: Requirement Detail -->
        <div class="panel">
            <div class="panel-header">
                Requirement Detail
            </div>
            <div class="panel-content" id="requirementDetail">
                <div class="empty-state">
                    <div class="empty-state-icon">📋</div>
                    <p>Select a requirement to view details</p>
                </div>
            </div>
        </div>

        <!-- Right Panel: Stakeholder Alignment -->
        <div class="panel">
            <div class="panel-header">
                Stakeholder Alignment
            </div>
            <div class="panel-content" id="alignmentPanel">
                <div class="dashboard-summary">
                    <h4 style="font-size: 14px; color: #2d3748; margin-bottom: 8px;">Overall Progress</h4>
                    <div class="progress-bar">
                        <div class="progress-fill" id="overallProgress" style="width: 0%"></div>
                    </div>
                    <div class="progress-text" id="progressText">0/0 requirements aligned</div>
                </div>

                <div class="summary-grid" id="stakeholderSummary">
                    <!-- Stakeholder summaries will be populated here -->
                </div>

                <div id="unblockingActions">
                    <!-- Unblocking actions will appear here -->
                </div>

                <div id="stakeholderCards">
                    <div class="empty-state">
                        <div class="empty-state-icon">👥</div>
                        <p>Select a requirement to see stakeholder alignment</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Discussion Modal -->
    <div id="discussionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Discussion Thread</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="discussionContent">
                <!-- Discussion thread will be populated here -->
            </div>
        </div>
    </div>

    <!-- PRD Preview Modal -->
    <div id="prdModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>PRD Preview</h2>
                <button class="modal-close" onclick="closePRDModal()">&times;</button>
            </div>
            <div class="prd-preview" id="prdPreview">
                <!-- PRD content will be populated here -->
            </div>
            <button class="btn-export" onclick="exportPRD()">📄 Export to PDF</button>
            <button class="btn-export" style="margin-top: 8px; background: #48bb78;" onclick="finalizePRD()">🔒 Mark PRD as Final</button>
        </div>
    </div>

    <script>
        // Sample data
        const stakeholders = [
            { id: 'sarah', name: 'Sarah Chen', role: 'Tech Lead', avatar: 'SC', color: 'sarah' },
            { id: 'mike', name: 'Mike Johnson', role: 'Product Manager', avatar: 'MJ', color: 'mike' },
            { id: 'emma', name: 'Emma Davis', role: 'UX Designer', avatar: 'ED', color: 'emma' },
            { id: 'david', name: 'David Park', role: 'Business Analyst', avatar: 'DP', color: 'david' }
        ];

        let requirements = [
            {
                id: 'REQ-001',
                title: 'User Authentication System',
                description: 'Implement secure user authentication with JWT tokens and OAuth 2.0 support',
                type: 'Technical',
                priority: 'Critical',
                owner: 'sarah',
                dependencies: [],
                acceptanceCriteria: [
                    'Support email/password login',
                    'Implement OAuth 2.0 (Google, GitHub)',
                    'JWT token refresh mechanism',
                    'Password reset functionality'
                ],
                alignments: {
                    sarah: { status: 'aligned', timestamp: '2025-09-30 10:30 AM', comment: 'Solid technical approach' },
                    mike: { status: 'concern', concern: 'Timeline seems tight for OAuth integration', compromise: 'Start with email/password, add OAuth in phase 2' },
                    emma: { status: 'aligned', timestamp: '2025-09-30 11:15 AM', comment: 'UI mockups ready' },
                    david: { status: 'blocked', blocker: 'Need compliance review for data storage', unblockAction: 'Schedule meeting with Legal team' }
                }
            },
            {
                id: 'REQ-002',
                title: 'Real-time Dashboard Updates',
                description: 'Dashboard should reflect live data changes using WebSocket connections',
                type: 'Functional',
                priority: 'High',
                owner: 'mike',
                dependencies: ['REQ-001'],
                acceptanceCriteria: [
                    'WebSocket connection management',
                    'Auto-reconnect on disconnect',
                    'Update latency < 500ms',
                    'Handle 1000+ concurrent users'
                ],
                alignments: {
                    sarah: { status: 'concern', concern: 'Scalability concerns with current architecture', compromise: 'Use Redis pub/sub for horizontal scaling' },
                    mike: { status: 'aligned', timestamp: '2025-09-30 09:45 AM', comment: 'Critical for user experience' },
                    emma: { status: 'aligned', timestamp: '2025-09-30 10:00 AM', comment: 'Will add loading states' },
                    david: { status: 'aligned', timestamp: '2025-09-30 10:20 AM', comment: 'Good ROI on this feature' }
                }
            },
            {
                id: 'REQ-003',
                title: 'Advanced Filtering System',
                description: 'Users can filter requirements by status, owner, priority, and custom tags',
                type: 'Functional',
                priority: 'Medium',
                owner: 'emma',
                dependencies: [],
                acceptanceCriteria: [
                    'Multi-select filters',
                    'Save filter presets',
                    'Filter persistence across sessions',
                    'Clear all filters button'
                ],
                alignments: {
                    sarah: { status: 'aligned', timestamp: '2025-09-30 11:30 AM', comment: 'Straightforward implementation' },
                    mike: { status: 'aligned', timestamp: '2025-09-30 11:35 AM', comment: 'Users have requested this' },
                    emma: { status: 'aligned', timestamp: '2025-09-30 11:40 AM', comment: 'Already designed' },
                    david: { status: 'aligned', timestamp: '2025-09-30 11:45 AM', comment: 'Approved' }
                }
            },
            {
                id: 'REQ-004',
                title: 'API Rate Limiting',
                description: 'Implement rate limiting to prevent API abuse and ensure fair usage',
                type: 'Technical',
                priority: 'High',
                owner: 'sarah',
                dependencies: [],
                acceptanceCriteria: [
                    '100 requests per minute per user',
                    '429 status with retry-after header',
                    'Admin exemption capability',
                    'Rate limit dashboard'
                ],
                alignments: {
                    sarah: { status: 'aligned', timestamp: '2025-09-30 12:00 PM', comment: 'Essential for production' },
                    mike: { status: 'concern', concern: 'Might impact power users negatively', compromise: 'Tiered limits based on user plan' },
                    emma: { status: 'aligned', timestamp: '2025-09-30 12:10 PM', comment: 'No UI impact' },
                    david: { status: 'blocked', blocker: 'Need pricing strategy for tiered plans', unblockAction: 'Schedule pricing strategy meeting' }
                }
            },
            {
                id: 'REQ-005',
                title: 'Export to PDF/Excel',
                description: 'Allow users to export requirements and reports in multiple formats',
                type: 'Functional',
                priority: 'Low',
                owner: 'mike',
                dependencies: ['REQ-003'],
                acceptanceCriteria: [
                    'PDF export with company branding',
                    'Excel export with formatting',
                    'Include filters in export',
                    'Email export option'
                ],
                alignments: {
                    sarah: { status: 'aligned', timestamp: '2025-09-30 01:00 PM', comment: 'Use existing libraries' },
                    mike: { status: 'aligned', timestamp: '2025-09-30 01:05 PM', comment: 'Requested by stakeholders' },
                    emma: { status: 'concern', concern: 'PDF templates need design review', compromise: 'Start with basic template, iterate based on feedback' },
                    david: { status: 'aligned', timestamp: '2025-09-30 01:15 PM', comment: 'Low priority, but useful' }
                }
            }
        ];

        let currentRequirement = null;
        let currentFilter = 'all';

        // Initialize
        function init() {
            renderRequirementsList();
            updateStakeholderSummary();
            updateOverallProgress();
        }

        // Render requirements list
        function renderRequirementsList() {
            const container = document.getElementById('requirementsList');
            const filteredReqs = filterRequirementsByStatus();

            container.innerHTML = filteredReqs.map(req => {
                const alignmentSummary = getAlignmentSummary(req);
                return `
                    <div class="requirement-item ${currentRequirement?.id === req.id ? 'active' : ''}"
                         onclick="selectRequirement('${req.id}')">
                        <div class="req-header">
                            <span class="req-id">${req.id}</span>
                        </div>
                        <div class="req-title">${req.title}</div>
                        <div class="req-meta">
                            <span class="priority-badge priority-${req.priority.toLowerCase()}">${req.priority}</span>
                            <span class="type-badge">${req.type}</span>
                        </div>
                        <div class="alignment-status">
                            ${alignmentSummary.aligned > 0 ? `<span class="status-icon status-aligned">${alignmentSummary.aligned}</span>` : ''}
                            ${alignmentSummary.concern > 0 ? `<span class="status-icon status-concern">${alignmentSummary.concern}</span>` : ''}
                            ${alignmentSummary.blocked > 0 ? `<span class="status-icon status-blocked">${alignmentSummary.blocked}</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Get alignment summary for a requirement
        function getAlignmentSummary(req) {
            const summary = { aligned: 0, concern: 0, blocked: 0 };
            Object.values(req.alignments).forEach(alignment => {
                summary[alignment.status]++;
            });
            return summary;
        }

        // Filter requirements by status
        function filterRequirementsByStatus() {
            if (currentFilter === 'all') return requirements;

            return requirements.filter(req => {
                const summary = getAlignmentSummary(req);
                if (currentFilter === 'aligned') return summary.blocked === 0 && summary.concern === 0;
                if (currentFilter === 'concern') return summary.concern > 0;
                if (currentFilter === 'blocked') return summary.blocked > 0;
                return true;
            });
        }

        // Filter requirements
        function filterRequirements(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderRequirementsList();
        }

        // Select requirement
        function selectRequirement(reqId) {
            currentRequirement = requirements.find(r => r.id === reqId);
            renderRequirementDetail();
            renderStakeholderAlignment();
            renderUnblockingActions();
        }

        // Render requirement detail
        function renderRequirementDetail() {
            const container = document.getElementById('requirementDetail');
            const req = currentRequirement;

            container.innerHTML = `
                <div class="detail-section">
                    <h3>Requirement ID</h3>
                    <input type="text" class="detail-input" value="${req.id}" readonly>
                </div>

                <div class="detail-section">
                    <h3>Title</h3>
                    <input type="text" class="detail-input" value="${req.title}"
                           onchange="updateRequirement('title', this.value)">
                </div>

                <div class="detail-section">
                    <h3>Description</h3>
                    <textarea class="detail-input" onchange="updateRequirement('description', this.value)">${req.description}</textarea>
                </div>

                <div class="detail-section">
                    <h3>Type</h3>
                    <select class="select-input" onchange="updateRequirement('type', this.value)">
                        <option ${req.type === 'Functional' ? 'selected' : ''}>Functional</option>
                        <option ${req.type === 'Technical' ? 'selected' : ''}>Technical</option>
                        <option ${req.type === 'Business' ? 'selected' : ''}>Business</option>
                        <option ${req.type === 'Constraint' ? 'selected' : ''}>Constraint</option>
                    </select>
                </div>

                <div class="detail-section">
                    <h3>Priority</h3>
                    <select class="select-input" onchange="updateRequirement('priority', this.value)">
                        <option ${req.priority === 'Low' ? 'selected' : ''}>Low</option>
                        <option ${req.priority === 'Medium' ? 'selected' : ''}>Medium</option>
                        <option ${req.priority === 'High' ? 'selected' : ''}>High</option>
                        <option ${req.priority === 'Critical' ? 'selected' : ''}>Critical</option>
                    </select>
                </div>

                <div class="detail-section">
                    <h3>Owner</h3>
                    <select class="select-input" onchange="updateRequirement('owner', this.value)">
                        ${stakeholders.map(s => `
                            <option value="${s.id}" ${req.owner === s.id ? 'selected' : ''}>${s.name}</option>
                        `).join('')}
                    </select>
                </div>

                <div class="detail-section">
                    <h3>Dependencies</h3>
                    <div class="dependencies-list">
                        ${req.dependencies.map(dep => `
                            <span class="dependency-chip">
                                ${dep}
                                <span class="remove-chip" onclick="removeDependency('${dep}')">&times;</span>
                            </span>
                        `).join('')}
                    </div>
                    <button class="btn-add-criteria" onclick="addDependency()">+ Add Dependency</button>
                </div>

                <div class="detail-section">
                    <h3>Acceptance Criteria</h3>
                    <ul class="acceptance-criteria">
                        ${req.acceptanceCriteria.map((criteria, idx) => `
                            <li class="criteria-item">
                                <input type="text" class="detail-input" value="${criteria}"
                                       onchange="updateCriteria(${idx}, this.value)">
                            </li>
                        `).join('')}
                    </ul>
                    <button class="btn-add-criteria" onclick="addCriteria()">+ Add Criteria</button>
                </div>
            `;
        }

        // Render stakeholder alignment
        function renderStakeholderAlignment() {
            const container = document.getElementById('stakeholderCards');
            const req = currentRequirement;

            container.innerHTML = stakeholders.map(stakeholder => {
                const alignment = req.alignments[stakeholder.id];
                return `
                    <div class="stakeholder-card">
                        <div class="stakeholder-header">
                            <div class="avatar avatar-${stakeholder.color}">
                                ${stakeholder.avatar}
                                <span class="status-badge badge-${alignment.status}">
                                    ${alignment.status === 'aligned' ? '✓' : alignment.status === 'concern' ? '!' : '✗'}
                                </span>
                            </div>
                            <div class="stakeholder-info">
                                <h4>${stakeholder.name}</h4>
                                <div class="stakeholder-role">${stakeholder.role}</div>
                            </div>
                        </div>

                        <div class="alignment-actions">
                            <button class="btn-alignment btn-aligned ${alignment.status === 'aligned' ? 'active' : ''}"
                                    onclick="setAlignment('${stakeholder.id}', 'aligned')">
                                ✅ Aligned
                            </button>
                            <button class="btn-alignment btn-concern ${alignment.status === 'concern' ? 'active' : ''}"
                                    onclick="setAlignment('${stakeholder.id}', 'concern')">
                                ⚠️ Concern
                            </button>
                            <button class="btn-alignment btn-blocked ${alignment.status === 'blocked' ? 'active' : ''}"
                                    onclick="setAlignment('${stakeholder.id}', 'blocked')">
                                ❌ Blocked
                            </button>
                        </div>

                        ${alignment.status === 'aligned' ? `
                            <div class="timestamp">✓ Approved ${alignment.timestamp}</div>
                            ${alignment.comment ? `
                                <div class="comment-box">
                                    <div class="comment-text">"${alignment.comment}"</div>
                                </div>
                            ` : ''}
                        ` : ''}

                        ${alignment.status === 'concern' ? `
                            <div class="concern-panel">
                                <div class="panel-label">Concern</div>
                                <input type="text" class="concern-input" placeholder="Why are you hesitant?"
                                       value="${alignment.concern || ''}"
                                       onchange="updateConcern('${stakeholder.id}', 'concern', this.value)">

                                <div class="panel-label" style="margin-top: 8px;">Proposed Compromise</div>
                                <textarea class="concern-input" placeholder="What compromise would work?"
                                          onchange="updateConcern('${stakeholder.id}', 'compromise', this.value)">${alignment.compromise || ''}</textarea>

                                <div class="action-buttons">
                                    <button class="btn-action btn-accept" onclick="acceptCompromise('${stakeholder.id}')">
                                        Accept Compromise
                                    </button>
                                    <button class="btn-action btn-discuss" onclick="openDiscussion('${stakeholder.id}')">
                                        Discuss
                                    </button>
                                    <button class="btn-action btn-override" onclick="overrideAlignment('${stakeholder.id}')">
                                        Override (Admin)
                                    </button>
                                </div>
                            </div>
                        ` : ''}

                        ${alignment.status === 'blocked' ? `
                            <div class="blocked-panel">
                                <div class="panel-label">Blocker Reason</div>
                                <textarea class="blocked-input" placeholder="What's blocking your approval?"
                                          onchange="updateBlocker('${stakeholder.id}', 'blocker', this.value)">${alignment.blocker || ''}</textarea>

                                <div class="panel-label" style="margin-top: 8px;">What Would Unblock You?</div>
                                <textarea class="blocked-input" placeholder="What would make you align?"
                                          onchange="updateBlocker('${stakeholder.id}', 'unblockAction', this.value)">${alignment.unblockAction || ''}</textarea>

                                <div class="action-buttons">
                                    <button class="btn-action btn-schedule" onclick="scheduleUnblockMeeting('${stakeholder.id}')">
                                        📅 Schedule Meeting
                                    </button>
                                    <button class="btn-action btn-discuss" onclick="openDiscussion('${stakeholder.id}')">
                                        💬 Discuss
                                    </button>
                                </div>

                                <div class="discussion-thread" id="thread-${stakeholder.id}">
                                    <!-- Discussion thread will appear here -->
                                </div>

                                <div class="thread-input">
                                    <input type="text" placeholder="@mention or comment..."
                                           id="input-${stakeholder.id}">
                                    <button class="btn-send" onclick="sendMessage('${stakeholder.id}')">Send</button>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Render unblocking actions
        function renderUnblockingActions() {
            const container = document.getElementById('unblockingActions');
            const blockedStakeholders = stakeholders.filter(s =>
                currentRequirement.alignments[s.id].status === 'blocked'
            );

            if (blockedStakeholders.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = `
                <div class="unblock-panel">
                    <div class="unblock-header">
                        <span style="font-size: 20px;">🔓</span>
                        <h4>Unblock Actions Required</h4>
                    </div>
                    ${blockedStakeholders.map(s => {
                        const alignment = currentRequirement.alignments[s.id];
                        return `
                            <div class="unblock-item">
                                <strong>${s.name}</strong> is blocked
                                <div style="margin-top: 4px; color: #718096;">
                                    Reason: ${alignment.blocker}
                                </div>
                                <div class="unblock-action" onclick="scheduleUnblockMeeting('${s.id}')">
                                    → ${alignment.unblockAction}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Update stakeholder summary
        function updateStakeholderSummary() {
            const summary = {};
            stakeholders.forEach(s => {
                summary[s.id] = { aligned: 0, concern: 0, blocked: 0 };
            });

            requirements.forEach(req => {
                stakeholders.forEach(s => {
                    const status = req.alignments[s.id].status;
                    summary[s.id][status]++;
                });
            });

            const container = document.getElementById('stakeholderSummary');
            container.innerHTML = stakeholders.map(s => `
                <div class="summary-card">
                    <h4>${s.name.split(' ')[0]}</h4>
                    <div class="summary-stats">
                        <span class="stat-number stat-aligned">${summary[s.id].aligned}</span> ✅
                        <span class="stat-number stat-concern">${summary[s.id].concern}</span> ⚠️
                        <span class="stat-number stat-blocked">${summary[s.id].blocked}</span> ❌
                    </div>
                </div>
            `).join('');
        }

        // Update overall progress
        function updateOverallProgress() {
            let totalAligned = 0;
            let totalRequirements = requirements.length;

            requirements.forEach(req => {
                const summary = getAlignmentSummary(req);
                if (summary.blocked === 0 && summary.concern === 0) {
                    totalAligned++;
                }
            });

            const percentage = (totalAligned / totalRequirements) * 100;
            document.getElementById('overallProgress').style.width = percentage + '%';
            document.getElementById('progressText').textContent =
                `${totalAligned}/${totalRequirements} requirements fully aligned`;
        }

        // Set alignment status
        function setAlignment(stakeholderId, status) {
            currentRequirement.alignments[stakeholderId] = {
                status: status,
                timestamp: new Date().toLocaleString('en-US', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                }),
                concern: '',
                compromise: '',
                blocker: '',
                unblockAction: ''
            };

            renderStakeholderAlignment();
            renderRequirementsList();
            renderUnblockingActions();
            updateStakeholderSummary();
            updateOverallProgress();
        }

        // Update concern
        function updateConcern(stakeholderId, field, value) {
            currentRequirement.alignments[stakeholderId][field] = value;
        }

        // Update blocker
        function updateBlocker(stakeholderId, field, value) {
            currentRequirement.alignments[stakeholderId][field] = value;
        }

        // Accept compromise
        function acceptCompromise(stakeholderId) {
            const alignment = currentRequirement.alignments[stakeholderId];
            if (!alignment.compromise) {
                alert('Please provide a compromise proposal first');
                return;
            }

            if (confirm('Accept this compromise and mark as aligned?')) {
                setAlignment(stakeholderId, 'aligned');
                currentRequirement.alignments[stakeholderId].comment =
                    'Compromise accepted: ' + alignment.compromise;
                renderStakeholderAlignment();
            }
        }

        // Override alignment
        function overrideAlignment(stakeholderId) {
            const justification = prompt('Admin override requires justification:');
            if (justification) {
                setAlignment(stakeholderId, 'aligned');
                currentRequirement.alignments[stakeholderId].comment =
                    'Override by admin: ' + justification;
                renderStakeholderAlignment();
            }
        }

        // Schedule unblock meeting
        function scheduleUnblockMeeting(stakeholderId) {
            const stakeholder = stakeholders.find(s => s.id === stakeholderId);
            const subject = `Unblock ${currentRequirement.id}: ${currentRequirement.title}`;
            const body = `Meeting to resolve blocking issues for ${stakeholder.name}`;

            alert(`📅 Calendar invite sent to ${stakeholder.name}\n\nSubject: ${subject}\n\nNext: They will receive a meeting request with all relevant stakeholders.`);
        }

        // Open discussion modal
        function openDiscussion(stakeholderId) {
            const modal = document.getElementById('discussionModal');
            const stakeholder = stakeholders.find(s => s.id === stakeholderId);

            document.getElementById('discussionContent').innerHTML = `
                <h3>Discussion: ${currentRequirement.id} - ${stakeholder.name}</h3>
                <div class="discussion-thread">
                    <div class="thread-message">
                        <div class="thread-author">${stakeholder.name}</div>
                        <div class="thread-text">${currentRequirement.alignments[stakeholderId].concern || currentRequirement.alignments[stakeholderId].blocker}</div>
                    </div>
                    <div class="thread-message">
                        <div class="thread-author">System</div>
                        <div class="thread-text">Discussion thread started. @mention stakeholders to notify them.</div>
                    </div>
                </div>
                <div class="thread-input">
                    <input type="text" placeholder="Type your message..." style="flex: 1;">
                    <button class="btn-send">Send</button>
                </div>
            `;

            modal.classList.add('active');
        }

        // Send message
        function sendMessage(stakeholderId) {
            const input = document.getElementById(`input-${stakeholderId}`);
            const message = input.value.trim();

            if (message) {
                const thread = document.getElementById(`thread-${stakeholderId}`);
                const newMessage = document.createElement('div');
                newMessage.className = 'thread-message';
                newMessage.innerHTML = `
                    <div class="thread-author">You</div>
                    <div class="thread-text">${message}</div>
                `;
                thread.appendChild(newMessage);
                input.value = '';
            }
        }

        // Close modal
        function closeModal() {
            document.getElementById('discussionModal').classList.remove('active');
        }

        // Show PRD Preview
        function showPRDPreview() {
            const modal = document.getElementById('prdModal');
            generatePRDPreview();
            modal.classList.add('active');
        }

        // Generate PRD Preview
        function generatePRDPreview() {
            const alignedReqs = requirements.filter(req => {
                const summary = getAlignmentSummary(req);
                return summary.blocked === 0 && summary.concern === 0;
            });

            const openIssues = requirements.filter(req => {
                const summary = getAlignmentSummary(req);
                return summary.blocked > 0 || summary.concern > 0;
            });

            document.getElementById('prdPreview').innerHTML = `
                <div class="prd-section">
                    <h3>Executive Summary</h3>
                    <div class="prd-content">
                        This PRD outlines ${requirements.length} requirements for the project, of which ${alignedReqs.length}
                        are fully aligned by all stakeholders. The project focuses on building a robust requirements
                        management and traceability system with real-time collaboration capabilities.
                    </div>
                </div>

                <div class="prd-section">
                    <h3>Functional Requirements (${alignedReqs.length} Aligned)</h3>
                    <div class="prd-content">
                        <ul>
                            ${alignedReqs.map(req => `
                                <li><strong>${req.id}:</strong> ${req.title} (${req.priority} priority)</li>
                            `).join('')}
                        </ul>
                    </div>
                </div>

                ${openIssues.length > 0 ? `
                    <div class="prd-section">
                        <h3>Open Issues (${openIssues.length} Pending Alignment)</h3>
                        <div class="prd-content">
                            <ul>
                                ${openIssues.map(req => {
                                    const summary = getAlignmentSummary(req);
                                    return `<li><strong>${req.id}:</strong> ${req.title} -
                                        ${summary.concern} concerns, ${summary.blocked} blockers</li>`;
                                }).join('')}
                            </ul>
                        </div>
                    </div>
                ` : ''}

                <div class="prd-section">
                    <h3>Stakeholder Sign-offs</h3>
                    <ul class="signoff-list">
                        ${stakeholders.map(s => {
                            const totalReqs = requirements.length;
                            const alignedCount = requirements.filter(req =>
                                req.alignments[s.id].status === 'aligned'
                            ).length;
                            const isComplete = alignedCount === totalReqs;

                            return `
                                <li class="signoff-item">
                                    <span style="font-size: 18px;">${isComplete ? '✅' : '⏳'}</span>
                                    <strong>${s.name}</strong> (${s.role})
                                    - ${alignedCount}/${totalReqs} approved
                                </li>
                            `;
                        }).join('')}
                    </ul>
                </div>
            `;
        }

        // Close PRD modal
        function closePRDModal() {
            document.getElementById('prdModal').classList.remove('active');
        }

        // Export PRD
        function exportPRD() {
            alert('📄 Exporting PRD to PDF...\n\nIn production, this would generate a formatted PDF with:\n- Company branding\n- All aligned requirements\n- Stakeholder signatures\n- Version history');
        }

        // Finalize PRD
        function finalizePRD() {
            const alignedReqs = requirements.filter(req => {
                const summary = getAlignmentSummary(req);
                return summary.blocked === 0 && summary.concern === 0;
            });

            if (alignedReqs.length === requirements.length) {
                if (confirm('🔒 Mark this PRD as final?\n\nThis will:\n- Lock all requirements\n- Generate final document\n- Proceed to Module 4 (Implementation)\n- Notify all stakeholders')) {
                    alert('✅ PRD finalized!\n\nProceeding to Module 4: Implementation & Traceability Matrix\n\nAll stakeholders have been notified.');
                    window.location.href = 'module-4-implementation.html';
                }
            } else {
                alert(`⚠️ Cannot finalize PRD\n\n${requirements.length - alignedReqs.length} requirements still need full alignment.\n\nResolve all concerns and blockers before finalizing.`);
            }
        }

        // Update requirement
        function updateRequirement(field, value) {
            currentRequirement[field] = value;
            renderRequirementsList();
        }

        // Add criteria
        function addCriteria() {
            const newCriteria = prompt('Enter new acceptance criteria:');
            if (newCriteria) {
                currentRequirement.acceptanceCriteria.push(newCriteria);
                renderRequirementDetail();
            }
        }

        // Update criteria
        function updateCriteria(index, value) {
            currentRequirement.acceptanceCriteria[index] = value;
        }

        // Add dependency
        function addDependency() {
            const reqId = prompt('Enter requirement ID to add as dependency:');
            if (reqId && !currentRequirement.dependencies.includes(reqId)) {
                currentRequirement.dependencies.push(reqId);
                renderRequirementDetail();
            }
        }

        // Remove dependency
        function removeDependency(depId) {
            currentRequirement.dependencies = currentRequirement.dependencies.filter(d => d !== depId);
            renderRequirementDetail();
        }

        // Add header action buttons
        document.querySelector('.header').innerHTML += `
            <button class="btn-export" style="width: auto; margin: 0;" onclick="showPRDPreview()">
                📄 Preview PRD
            </button>
        `;

        // Initialize app
        init();
    </script>

    <!-- State Synchronization -->
    <script src="module-state-sync.js"></script>
    <script>
        // Initialize state sync for Module 3
        ConductorModuleState.init(3);

        // Listen for state updates from dashboard
        ConductorModuleState.onStateUpdate((detail) => {
            console.log('[Module 3] State updated from dashboard:', detail);
            // Restore requirements if available
            if (detail.newState.requirements) {
                requirements = detail.newState.requirements;
                renderRequirementsList();
            }
        });

        // Save requirements to state
        function saveRequirementsToState() {
            ConductorModuleState.updateState({
                requirements: requirements,
                currentRequirement: currentRequirement,
                lastModified: new Date().toISOString()
            }, { saveImmediately: true });
        }

        // Override existing functions to include state sync
        const originalAddRequirement = addRequirement;
        addRequirement = function() {
            originalAddRequirement.apply(this, arguments);
            saveRequirementsToState();
        };

        const originalSaveRequirement = saveRequirement;
        saveRequirement = function() {
            originalSaveRequirement.apply(this, arguments);
            saveRequirementsToState();
        };

        const originalDeleteRequirement = deleteRequirement;
        deleteRequirement = function(id) {
            originalDeleteRequirement(id);
            saveRequirementsToState();
        };

        // Save alignment status changes
        function saveAlignmentChange(reqId, status) {
            ConductorModuleState.updateState({
                [`alignment_${reqId}`]: status,
                lastAlignment: new Date().toISOString()
            }, { saveImmediately: true });
        }

        console.log('[Module 3] State synchronization initialized');
    </script>
</body>
</html>
